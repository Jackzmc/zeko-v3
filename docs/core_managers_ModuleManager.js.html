<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: core/managers/ModuleManager.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: core/managers/ModuleManager.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/** 
 @module core:managers/ModuleManager
 @description Manages all registered modules
*/
import path from 'path'
import Logger from '../Logger.js'

let instance, logger;

export default class {
    
    constructor(client) {
        this.modules = {},
        this.client = client;
        logger = new Logger("ModuleManager")
        instance = this
    }

    static getInstance() {
        return instance;
    }


    /**
     * Reload a module. Not working with ESM Modules
     *
     * @param {string} name Module name
     * @returns Promise&lt;>
     */
    reloadModule(name) {
        return new Promise((resolve,reject) => {
            const module = this.modules[name];
            if(!module) reject(new Error(`ModuleManager: No module found for ${name}`));
            if(module.reloadable != null &amp;&amp; !module.reloadable) {
                reject(new Error(`ModuleManager: Module ${name} cannot be reloaded.`))
                logger.warn(`Reloading module ${name} failed: Not Reloadable`)
                return;
            }

            this._reload(module)
            .then(() => {
                logger.info(`Successfully reloaded module ${name}`)
                resolve();
            }).catch(err => {
                logger.error(`Reloading module ${name} failed: ${err.message}`);
                reject(err);
            })
        })
    }


    /**
     * Register a {@link types/Module} in the ModuleManager
     *
     * @param {Module} module
     * @returns Promise&lt;>
     */
    registerModule(module) {
        const _this = this;
        return new Promise(async(resolve,reject) => {
            
            if(!module.config) reject(new Error(`Invalid module registered.`));
            try {
                this._moduleCheck(module)
                const logger = new Logger(module.config.name, {type:'module'})
                _this.modules[module.config.name] = module;

                if(module.config.command) this._registerCommandModule(module);
                if(module.init) await module.init(_this.client,logger);


                //logger.debug(`Registered${module.config.core?" Core ":" "}${module.config.command?"Command ":""}Module ${module.config.name}`);
                resolve();
            }catch(err) {
                reject(err);
            }
        })
    }


    /**
     *
     *
     * @param {string} query The name of the module
     * @returns {@link types/Module}
     */
    getModule(query) {
        return this.modules[query];
    }
    getModules(opts = {names:false}) {
        //{type: 'custom'}
        let filtered;
        if(opts.type) {
            if(opts.type === "custom") {
                filtered = this.modules.filter(v => !v.config.core)
            }else if(opts.type === "core") {
                filtered = this.modules.filter(v => v.config.core);
            }else{
                throw new Error("Unknown type specified of module");
            }
        }else{
            filtered = this.modules;
        }

        if(opts.names) {
            return Object.keys(this.modules)
        }else{
            return this.modules;
        }
    }

    ///#region PRIVATE METHODS
    _reload(module) {
        const _this = this;
        return new Promise(async(resolve,reject) => {
            try {
                //delete this.modules[module.config.name];
                const _logger = new Logger(module.config.name,{type:'module'})
                if(module.exit) await module.exit(this.client,_logger);
                
                const filepath = path.join(_this.client.ROOT_DIR,module.config.core?"src/modules/":"modules/",`${module.config.name}.js`)
                try {
                    delete require.cache[require.resolve(filepath)];
                    const newModule = require(filepath)
                    if(!newModule.config) newModule.config = {}
                    newModule.config.name = module.config.name;
                    newModule.config.core = module.config.core;
                    //do logic on register modules
                    _this.modules[module.config.name] = newModule;
                    if(newModule.init) await newModule.init(_this.client,_logger);
                    resolve();
                } catch(err) {
                    if(err.code === 'ENOENT') {
                        reject(new Error("Module does not exist"))
                    }else{
                        reject(err);
                    }
                }
            }catch(err) {
                reject(err);   
            }
        })
    }
    _moduleCheck(module) {
        const failed_dependencies = [];
        const failed_envs = [];
        if(module.config.dependencies) module.config.dependencies.forEach(v => {
            try {
                require.resolve(v)
            } catch(e) {
                failed_dependencies.push(v);
            }
        })
        if(module.config.envs) module.config.envs.forEach(v => {
            if(!process.env[v]) failed_envs.push(v);
        })
        if(failed_dependencies.length > 0) {
            logger.warn(`Module ${module.config.name} missing dependencies: ${failed_dependencies.join(" ")}`);
        }else if(failed_envs.length > 0) {
            logger.warn(`Module ${module.config.name} missing envs: ${failed_envs.join(" ")}`);
        }
    }
    /////#endregion
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="core_Database.html">core:Database</a></li><li><a href="core_loaders_CommandLoader.html">core:loaders/CommandLoader</a></li><li><a href="core_loaders_CoreLoader.html">core:loaders/CoreLoader</a></li><li><a href="core_loaders_EventLoader.html">core:loaders/EventLoader</a></li><li><a href="core_loaders_ModuleLoader.html">core:loaders/ModuleLoader</a></li><li><a href="core_managers_CommandManager.html">core:managers/CommandManager</a></li><li><a href="core_managers_DataManager.html">core:managers/DataManager</a></li><li><a href="core_managers_EventManager.html">core:managers/EventManager</a></li><li><a href="core_managers_ModuleManager.html">core:managers/ModuleManager</a></li><li><a href="core_types_CoreEvent.html">core:types/CoreEvent</a></li><li><a href="module-types_Event.html">types/Event</a></li><li><a href="module-Utils.html">Utils</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Sun Jun 28 2020 15:03:35 GMT-0500 (Central Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
